<style>
    /* Highlight row on hover with smooth transition */
    #courseTable tbody tr:hover {
        background-color: #e9f5ff;
        transition: background-color 0.25s ease;
        cursor: pointer;
    }


    /* Style DataTables search box */
    .dataTables_filter input {
        border-radius: 20px;
        padding: 6px 12px;
        border: 1px solid #ced4da;
        transition: border-color 0.3s ease;
        width: 250px;
    }

    .dataTables_filter input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
    }

    /* Style pagination buttons */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 8px;
        border: 1px solid transparent;
        padding: 5px 12px;
        margin: 0 2px;
        transition: background-color 0.3s, border-color 0.3s;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current,
    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background-color: #0d6efd !important;
        border-color: #0a58ca !important;
        color: white !important;
        box-shadow: 0 0 8px rgba(13, 110, 253, 0.5);
    }

    .dataTables_wrapper .dataTables_filter {
        float: right !important;
        text-align: left !important;
    }

    .dataTables_wrapper .dataTables_paginate {
        float: right !important;
        text-align: right !important;
    }

    .dataTables_wrapper .dataTables_length {
        float: left !important;
        margin-right: 1rem;
    }

    .dataTables_wrapper .dataTables_info {
        float: left !important;
        margin-top: 0.5rem;
    }

    .dataTables_wrapper .row {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
    }


    /* Responsive fix for smaller screens */
    @media (max-width: 576px) {
        #courseTable {
            font-size: 0.85rem;
        }
    }

    #statusFilter, #branchFilter {
        cursor: pointer;
    }

    .input-group-text {
        border-right: 0;
    }

    .input-group .form-select {
        border-left: 0;
    }

    .input-group:focus-within {
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
        border-radius: 0.375rem;
    }

    .btn-sm {
        font-weight: 500;
    }

    .btn-info, .btn-primary {
        transition: all 0.2s ease-in-out;
    }

    .btn-info:hover,
    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }


</style>

<h3 class="mb-3 fw-bold text-center">Gold Course</h3>
<div class="container-fluid shadow-sm p-3 rounded bg-white">

    <div class="row mb-4 g-3 align-items-end">

        <!-- Status Filter -->
        <div class="col-md-3">
            <label for="statusFilter" class="form-label fw-semibold text-muted">
                Course Status
            </label>
            <div class="input-group shadow-sm">
            <span class="input-group-text bg-light">
                <i class="bi bi-flag-fill text-primary"></i>
            </span>
                <select id="statusFilter" class="form-select">
                    <option value="">All Status</option>
                    <option value="YET_TO_START">Yet To Start</option>
                    <option value="ON_GOING">On Going</option>
                    <option value="COMPLETED">Completed</option>
                </select>
            </div>
        </div>

        <!-- Branch Filter -->
        <div class="col-md-3">
            <label for="branchFilter" class="form-label fw-semibold text-muted">
                Branch
            </label>
            <div class="input-group shadow-sm">
            <span class="input-group-text bg-light">
                <i class="bi bi-geo-alt-fill text-success"></i>
            </span>
                <select id="branchFilter" class="form-select">
                    <option value="">All Branches</option>
                </select>
            </div>
        </div>

        <!-- Clear Filters -->
        <div class="col-md-2">
            <button id="clearFilters" class="btn btn-outline-secondary w-100 shadow-sm">
                <i class="bi bi-x-circle"></i> Clear
            </button>
        </div>

    </div>


    <table id="courseTable" class="table table-hover table-striped table-bordered align-middle" style="width:100%">
        <thead class="table-light">
        <tr>
            <th>Phone Number</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Registered Date</th>
            <th>Branch</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>
    </table>
</div>

<!--
notify modal
-->
<div class="modal fade" id="notifyModal" tabindex="-1" aria-labelledby="notifyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="notifyForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notifyModalLabel">Send Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="notifyTitle" class="form-label">Title <span class="text-danger">*</span></label>
                    <input type="text" id="notifyTitle" name="title" class="form-control" maxlength="65" required>
                </div>
                <div class="mb-3">
                    <label for="notifyBody" class="form-label">Body</label>
                    <textarea id="notifyBody" name="body" class="form-control" maxlength="180" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-info">Send</button>
            </div>
        </form>
    </div>
</div>


<div class="modal fade" id="statusModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="statusForm" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Course Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select id="courseStatus" class="form-select" required>
                        <option value="">Select status</option>
                        <option value="YET_TO_START">Yet To Start</option>
                        <option value="ON_GOING">On Going</option>
                        <option value="COMPLETED">Completed</option>
                    </select>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    Update
                </button>
            </div>
        </form>
    </div>
</div>


<script>
    $(document).ready(function () {
        let typingTimer;
        const typingDelay = 500;
        let selectedNotifyUserId = null;
        let notifyAll = false;
        let selectedCourseId = null;

        function loadBranches() {
            $.ajax({
                url: localStorage.getItem("url").replace(/\/$/, "") + "/api/branch",
                method: "GET",
                headers: getAuthHeaders(),
                success: function (res) {
                    if (res.status && res.data) {
                        res.data.forEach(branch => {
                            $('#branchFilter').append(
                                `<option value="${branch.id}">${branch.name}</option>`
                            );
                        });
                    }
                }
            });
        }

        loadBranches();


        const table = $('#courseTable').DataTable({
            processing: true,
            serverSide: true,
            rowId: 'id',
            ordering: true,                 // enable ordering
            order: [[3, 'desc']],            // default sort by Date Created
            ajax: function (data, callback) {
                let limit = data.length;
                let offset = data.start;
                let sortField = data.columns[data.order[0].column].data;
                let sortOrder = data.order[0].dir;

                showLoading();

                $.ajax({
                    url: localStorage.getItem("url").replace(/\/$/, "") + "/api/admin/get_course_transactions",
                    method: "POST",
                    contentType: "application/json",
                    headers: getAuthHeaders(),
                    data: JSON.stringify({
                        limit,
                        offset,
                        sortField,
                        sortOrder,
                        search: data.search.value || null,
                        status: $('#statusFilter').val() || null,
                        branchId: $('#branchFilter').val() || null
                    }),
                    success: function (res) {
                        callback({
                            draw: data.draw,
                            recordsTotal: res.totalCount,
                            recordsFiltered: res.totalCount,
                            data: res.data
                        });
                    },
                    complete: function () {
                        setTimeout(hideLoading, 200);
                    }
                });
            },
            columns: [
                { data: 'username', className: "text-center", orderable: false },
                { data: 'firstName', className: "text-center", orderable: false },
                { data: 'lastName', className: "text-center", orderable: false },
                {
                    data: 'dateCreated',
                    className: "text-center",
                    orderable: true,
                    render: d => new Date(d).toLocaleString()
                },
                { data: 'branch', className: "text-center", orderable: false },
                {   data: 'status',
                    className: "text-center",
                    orderable: true,
                    render: status => {
                        const map = {
                            YET_TO_START: 'secondary',
                            ON_GOING: 'primary',
                            COMPLETED: 'success'
                        };

                        return `<span class="badge bg-${map[status]}">${formatStatus(status)}</span>`;
                    }
                },
                {
                    data: null,
                    className: "text-center",
                    orderable: false,
                    searchable: false,
                    render: row => {
                        return `
        <div class="d-flex justify-content-center gap-2">
            <button
                class="btn btn-info btn-sm notify-user px-3"
                data-id="${row.userId}"
            >
                Notify
            </button>

            <button
                class="btn btn-primary btn-sm update-status px-3"
                data-id="${row.id}"
            >
                Update Status
            </button>
        </div>
    `;
                    }

                }
            ],
            pageLength: 10,
            lengthMenu: [10, 20, 50],
            scrollY: '60vh',
            scrollCollapse: true,
            language: {
                searchPlaceholder: "Search users..."
            }
        });

        // Debounce search input
        $('#courseTable_filter input').unbind().on('input', function () {
            const searchTerm = this.value;
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                table.search(searchTerm).draw();
            }, typingDelay);
        });


        $('#statusFilter, #branchFilter').on('change', function () {
            table.ajax.reload();
        });


        // Notify Single User
        $('#courseTable').on('click', '.notify-user', function () {
            selectedNotifyUserId = $(this).data('id');
            $('#notifyTitle').val("");
            $('#notifyBody').val("");
            $('#notifyModal').modal('show');
        });

        // Submit Notification
        $("#notifyForm").validate({
            rules: {
                title: {
                    required: true,
                    maxlength: 65
                },
                body: {
                    maxlength: 180
                }
            },
            messages: {
                title: {
                    required: "Title is required.",
                    maxlength: "Title must be at most 65 characters."
                },
                body: {
                    maxlength: "Body must be at most 180 characters."
                }
            },
            errorClass: "is-invalid",
            validClass: "is-valid",
            errorPlacement: function (error, element) {
                error.addClass("invalid-feedback");
                error.insertAfter(element);
            },
            submitHandler: function () {
                const payload = {
                    title: $('#notifyTitle').val().trim(),
                    body: $('#notifyBody').val().trim()
                };

                let apiUrl = `/api/admin/notify_user`;
                payload.userId = selectedNotifyUserId;

                showLoading();

                $.ajax({
                    url: localStorage.getItem("url").replace(/\/$/, "") + apiUrl,
                    method: "POST",
                    headers: getAuthHeaders(),
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function () {
                        $('#notifyModal').modal('hide');
                        toastr.success(notifyAll ? "Notification sent to all users!" : "Notification sent successfully!");
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            localStorage.clear();
                            window.location.href = "login.html";
                        } else {
                            toastr.error("Error sending notification.");
                        }
                    },
                    complete: function () {
                        setTimeout(hideLoading, 200)
                    }
                });
            }
        });

        $('#courseTable').on('click', '.update-status', function () {
            selectedCourseId = $(this).data('id');

            // Get the current row data from DataTable
            const rowData = table.row($(this).closest('tr')).data();

            // Pre-select the current status in the modal
            $('#courseStatus').val(rowData.status);

            $('#statusModal').modal('show');
        });


        $('#statusForm').on('submit', function (e) {
            e.preventDefault();

            const status = $('#courseStatus').val();
            if (!status) return;

            showLoading();

            $.ajax({
                url: localStorage.getItem("url").replace(/\/$/, "") + "/api/admin/course/status",
                method: "POST",
                headers: getAuthHeaders(),
                contentType: "application/json",
                data: JSON.stringify({
                    id: selectedCourseId,
                    status: status
                }),
                success: function () {
                    $('#statusModal').modal('hide');
                    toastr.success("Course status updated successfully");
                    $('#courseTable').DataTable().ajax.reload(null, false);
                },
                error: function (xhr) {
                    if (xhr.status === 401) {
                        localStorage.clear();
                        window.location.href = "login.html";
                    } else {
                        toastr.error("Failed to update course status");
                    }
                },
                complete: function () {
                    setTimeout(hideLoading, 200);
                }
            });
        });


        const formatStatus = status =>
            status.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());

        $('#clearFilters').on('click', function () {
            $('#statusFilter').val('');
            $('#branchFilter').val('');
            table.ajax.reload();
        });


    });
</script>